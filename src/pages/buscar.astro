---
import Layout from "../layouts/Layout.astro";
import Card from '../components/Card.astro';
import { searchMovies, fetchMoviesByGenre } from "../lib/api.js";

export const prerender = false; // Enable SSR for dynamic search

const query = Astro.url.searchParams.get('q')?.trim() || '';

let searchResults: any[] = [];
let similarResults: any[] = [];

if (query) {
  try {
    // Search for movies using our API function
    const allResults = await searchMovies(query);
    searchResults = allResults.slice(0, 15);

    const genreKeywords = ['action', 'comedy', 'drama', 'horror', 'thriller', 'romance', 'sci-fi', 'fantasy', 'animation', 'documentary'];
    const queryLower = query.toLowerCase();
    const matchedGenre = genreKeywords.find(genre => queryLower.includes(genre));

    if (matchedGenre) {
      const genreData = await fetchMoviesByGenre(matchedGenre);
      if (genreData.Search) {
        similarResults = genreData.Search
          .filter((movie: any) => !searchResults.some(result => result.imdbID === movie.imdbID))
          .slice(0, 8);
      }
    }
  } catch (error) {
    console.error('Search error:', error);
  }
}
---

<Layout>
  <div class="min-h-screen bg-[rgb(var(--bg))] py-8 pt-24 md:pt-32 pb-24 md:pb-0">
    <div class="max-w-6xl mx-auto px-4">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-[rgb(var(--text))] mb-2">
          Resultados para "{query}"
        </h1>
        <p class="text-[rgb(var(--text-secondary))]">
          {searchResults.length + similarResults.length} resultados encontrados
        </p>
      </div>

      <!-- Search Results -->
      {searchResults.length > 0 && (
        <div class="mb-12">
          <h2 class="text-2xl font-semibold text-[rgb(var(--text))] mb-6">Resultados Exactos</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
            {searchResults.map((movie: any) => (
              <Card movie={movie} />
            ))}
          </div>
        </div>
      )}

      <!-- Similar Results -->
      {similarResults.length > 0 && (
        <div class="mb-12">
          <h2 class="text-2xl font-semibold text-[rgb(var(--text))] mb-6">Resultados Similares</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {similarResults.map((movie: any) => (
              <Card movie={movie} />
            ))}
          </div>
        </div>
      )}

      <!-- No Results -->
      {searchResults.length === 0 && similarResults.length === 0 && query && (
        <div class="text-center py-12">
          <div class="material-icons text-6xl text-[rgb(var(--text-secondary))] mb-4">search_off</div>
          <h3 class="text-xl font-semibold text-[rgb(var(--text-secondary))] mb-2">No se encontraron resultados</h3>
          <p class="text-[rgb(var(--text))] mb-6">
            No encontramos pel√≠culas que coincidan con "{query}"
          </p>
          <div class="space-y-2 text-sm text-[rgb(var(--text-secondary))]">
            <p>üí° <strong>Sugerencias:</strong></p>
            <ul class="text-left inline-block">
              <li>‚Ä¢ Verifica la ortograf√≠a</li>
              <li>‚Ä¢ Prueba con palabras clave m√°s generales</li>
              <li>‚Ä¢ Busca por t√≠tulo, actor o director</li>
            </ul>
          </div>
        </div>
      )}

      <!-- Back to Home -->
      <div class="text-center mt-12">
        <a
          href="/"
          class="inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
        >
          <span class="material-icons">home</span>
          Volver al Inicio
        </a>
      </div>
    </div>
  </div>
</Layout>
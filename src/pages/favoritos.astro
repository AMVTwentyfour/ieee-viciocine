---
import Layout from '../layouts/Layout.astro';
import Modal from '../components/Modal.astro';
---

<Layout>
  <section class="py-20 px-4 text-center">
    <h1 class="text-4xl md:text-6xl font-extrabold mb-4 text-gray-800">Mis Favoritos</h1>
    <p class="text-lg md:text-xl text-gray-600 mb-8">Tus películas y series favoritas guardadas</p>
  </section>

  <section class="py-12 px-4">
    <div id="favorites-container" class="md:grid md:grid-cols-4 lg:grid-cols-6 md:gap-4 flex flex-wrap justify-center gap-4">
      <!-- Favorites will be loaded here -->
    </div>
    <div id="empty-state" class="text-center py-20 hidden">
      <span class="material-icons text-6xl text-gray-400 mb-4">favorite_border</span>
      <h3 class="text-2xl font-semibold text-gray-600 mb-2">No tienes favoritos aún</h3>
      <p class="text-gray-500 mb-6">Agrega películas y series a tus favoritos haciendo clic en el corazón</p>
      <a href="/" class="inline-block bg-blue-600 text-white font-semibold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition-colors">
        Explorar películas
      </a>
    </div>
  </section>

  <Modal />
</Layout>

<script>
  import { getFavorites } from '../lib/favorites.js';
  import { fetchMovieDetails } from '../lib/api.js';

  async function loadFavorites() {
    const favoriteIds = getFavorites();
    const container = document.getElementById('favorites-container');
    const emptyState = document.getElementById('empty-state');

    if (!container || !emptyState) return;

    if (favoriteIds.length === 0) {
      emptyState.classList.remove('hidden');
      return;
    }

    emptyState.classList.add('hidden');
    container.innerHTML = ''; // Clear previous content

    let loadedCount = 0;

    for (const id of favoriteIds) {
      try {
        const movie = await fetchMovieDetails(id);
        if (movie && movie.Title && movie.imdbID) {
          const cardHTML = `
            <div class="shrink-0 w-40 md:w-auto bg-linear-to-br from-white to-gray-50 bg-opacity-90 backdrop-blur-xl rounded-xl overflow-hidden hover:scale-105 transition-all duration-500 ease-out animate-fade-in-up cursor-pointer card h-64 relative" data-imdbid="${movie.imdbID}">
              <button class="absolute top-2 right-2 bg-white bg-opacity-80 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-100 transition-all favorite-btn" data-imdbid="${movie.imdbID}">
                <span class="material-icons text-red-500 text-base leading-none">favorite</span>
              </button>
              <img src="${movie.Poster !== 'N/A' ? movie.Poster : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='}" alt="${movie.Title}" class="w-full h-48 object-cover rounded-t-xl" loading="lazy">
              <div class="p-4">
                <h3 class="font-semibold text-sm truncate">${movie.Title}</h3>
                <p class="text-gray-600 text-xs">${movie.Year || 'N/A'}</p>
              </div>
            </div>
          `;
          container.innerHTML += cardHTML;
          loadedCount++;
        }
      } catch (error) {
        console.error(`Error fetching movie ${id}:`, error);
      }
    }

    // If no cards were loaded successfully, show empty state
    if (loadedCount === 0) {
      emptyState.classList.remove('hidden');
    }

    // Add event listeners for cards and favorite buttons
    const cards = container.querySelectorAll('.card');
    cards.forEach(card => {
      card.addEventListener('click', () => {
        const imdbID = card.getAttribute('data-imdbid');
        if (imdbID) {
          openModal(imdbID);
        }
      });
    });

    const favoriteBtns = container.querySelectorAll('.favorite-btn');
    favoriteBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const imdbID = btn.getAttribute('data-imdbid');
        if (imdbID) {
          // Remove from favorites and reload
          const favorites = getFavorites();
          const index = favorites.indexOf(imdbID);
          if (index > -1) {
            favorites.splice(index, 1);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            loadFavorites(); // Reload the page content
          }
        }
      });
    });
  }

  // Modal functions
  async function openModal(imdbID: string) {
    const data = await fetchMovieDetails(imdbID);
    
    const modalContent = document.getElementById('modal-content');
    if (!modalContent) {
      console.error('Modal content element not found');
      return;
    }
    modalContent.innerHTML = `
      <img src="${data.Poster !== 'N/A' ? data.Poster : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='}" alt="${data.Title}" class="w-full h-64 object-cover rounded-xl mb-4 shadow-lg">
      <h2 class="text-2xl font-bold mb-2 text-gray-800">${data.Title}</h2>
      <div class="flex items-center gap-2 mb-3 text-sm text-gray-600">
        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${data.Year}</span>
        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${data.Genre?.split(',')[0]}</span>
        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">${data.Runtime}</span>
      </div>
      <p class="text-gray-700 mb-4 leading-relaxed">${data.Plot}</p>
      <div class="grid grid-cols-1 gap-2 text-sm mb-6">
        <p><strong class="text-gray-800">Director:</strong> ${data.Director}</p>
        <p><strong class="text-gray-800">Actores:</strong> ${data.Actors}</p>
        <p><strong class="text-gray-800">IMDB Rating:</strong> <span class="text-yellow-600 font-semibold">${data.imdbRating}</span></p>
      </div>
      <div class="flex gap-3">
        <a href="/movie/${imdbID}" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-center">
          Ver Detalle Completo
        </a>
      </div>
    `;
    
    const modal = document.getElementById('modal');
    if (!modal) {
      console.error('Modal element not found');
      return;
    }
    modal.setAttribute('data-current-imdbid', imdbID);
    modal.classList.remove('hidden');
    document.body.classList.add('overflow-hidden');
    setTimeout(() => {
      modal.classList.remove('opacity-0', 'scale-95');
      modal.classList.add('opacity-100', 'scale-100');
    }, 10);

    // Update favorite button in modal
    const favoriteBtn = document.getElementById('favorite-modal-btn');
    if (favoriteBtn) {
      const icon = favoriteBtn.querySelector('.material-icons');
      if (icon) {
        if (getFavorites().includes(imdbID)) {
          icon.textContent = 'favorite';
          icon.classList.add('text-red-600');
        } else {
          icon.textContent = 'favorite_border';
          icon.classList.remove('text-red-600');
        }
      }
    }
  }

  function closeModal() {
    const modal = document.getElementById('modal');
    if (!modal) {
      console.error('Modal element not found');
      return;
    }
    modal.classList.remove('opacity-100', 'scale-100');
    modal.classList.add('opacity-0', 'scale-95');
    document.body.classList.remove('overflow-hidden');
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadFavorites();

    const closeModalBtn = document.getElementById('close-modal');
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', closeModal);
    } else {
      console.error('Close modal button not found');
    }

    const modal = document.getElementById('modal');
    if (modal) {
      modal.addEventListener('click', (e: MouseEvent) => {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Handle favorite button in modal
      const favoriteBtn = document.getElementById('favorite-modal-btn');
      if (favoriteBtn) {
        favoriteBtn.addEventListener('click', () => {
          const imdbID = modal.getAttribute('data-current-imdbid');
          if (imdbID) {
            const icon = favoriteBtn.querySelector('.material-icons');
            if (icon) {
              const favorites = getFavorites();
              const index = favorites.indexOf(imdbID);
              if (index > -1) {
                favorites.splice(index, 1);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                icon.textContent = 'favorite_border';
                icon.classList.remove('text-red-600');
                loadFavorites(); // Reload favorites
              } else {
                favorites.push(imdbID);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                icon.textContent = 'favorite';
                icon.classList.add('text-red-600');
                loadFavorites(); // Reload favorites
              }
            }
          }
        });
      }
    } else {
      console.error('Modal element not found');
    }
  });
</script>
---
import Layout from "../layouts/Layout.astro";
import Section from "../components/Section.astro";
import Modal from "../components/Modal.astro";
import {
	fetchLatestMovies,
	fetchLatestSeries,
	fetchMoviesByGenre,
} from "../lib/api.js";

// Fetch latest movies (2024)
let latestMovies = { Search: [] };
try {
  latestMovies = await fetchLatestMovies("2025");
} catch (error) {
  console.error('Error fetching latest movies:', error);
}

// Fetch latest series (2024)
let latestSeries = { Search: [] };
try {
  latestSeries = await fetchLatestSeries("2025");
} catch (error) {
  console.error('Error fetching latest series:', error);
}

// Fetch horror movies
let horrorMovies = { Search: [] };
try {
  horrorMovies = await fetchMoviesByGenre("horror", "movie");
} catch (error) {
  console.error('Error fetching horror movies:', error);
}

// Fetch action movies
let actionMovies = { Search: [] };
try {
  actionMovies = await fetchMoviesByGenre("action", "movie");
} catch (error) {
  console.error('Error fetching action movies:', error);
}
---

<Layout>
	<!-- Banner -->
	<section
		class="relative bg-linear-to-r from-blue-600 to-purple-700 text-white py-20 px-4 text-center overflow-hidden"
	>
		<div class="absolute inset-0 bg-black opacity-10"></div>
		<div class="relative z-10 max-w-4xl mx-auto animate-fade-in-up">
			<h1
				class="text-5xl md:text-7xl font-extrabold mb-4 text-white drop-shadow-lg"
			>
				Descubre tu próxima película favorita
			</h1>
			<p class="text-lg md:text-xl mb-8">
				Explora, swipea y agrega a tu watchlist como en Tinder
			</p>
			<a
				href="/swiper"
				class="inline-block bg-white text-blue-600 font-semibold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 hover:scale-105 transition-all duration-300 animate-pulse"
			>
				¡Empieza a Swiper!
			</a>
		</div>
	</section>

	<Section title="Peliculas" movies={latestMovies.Search} delay="0.4s" />

	<Section title="Series" movies={latestSeries.Search} delay="0.4s" />

	<Section title="Terror" movies={horrorMovies.Search} delay="0.4s" />

	<Section title="Acción" movies={actionMovies.Search} delay="0.4s" />

	<Modal />
</Layout>

<script>
	import { fetchMovieDetails } from "../lib/api.js";
	import { addFavorite, removeFavorite, isFavorite } from "../lib/favorites.js";

	// Placeholder images
	const placeholderLarge = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQ1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=";

	async function openModal(imdbID: string) {
		try {
			const data = await fetchMovieDetails(imdbID);

		const modalContent = document.getElementById("modal-content");
		if (!modalContent) {
			console.error("Modal no encontrado");
			return;
		}

		const posterUrl = data.Poster && data.Poster !== "N/A" ? data.Poster : placeholderLarge;

		modalContent.innerHTML = `
      <img src="${posterUrl}" alt="${data.Title || 'Movie'}" class="w-full h-64 object-cover rounded-xl mb-4 shadow-lg">
      <h2 class="text-2xl font-bold mb-2 text-gray-800">${data.Title || 'Unknown Title'}</h2>
      <div class="flex items-center gap-2 mb-3 text-sm text-gray-600">
        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${data.Year || 'N/A'}</span>
        <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${data.Genre?.split(',')[0] || 'N/A'}</span>
        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">${data.Runtime || 'N/A'}</span>
      </div>
      <p class="text-gray-700 mb-4 leading-relaxed">${data.Plot || 'No description available.'}</p>
      <div class="grid grid-cols-1 gap-2 text-sm mb-6">
        <p><strong class="text-gray-800">Director:</strong> ${data.Director || 'N/A'}</p>
        <p><strong class="text-gray-800">Actores:</strong> ${data.Actors || 'N/A'}</p>
        <p><strong class="text-gray-800">IMDB Rating:</strong> <span class="text-yellow-600 font-semibold">${data.imdbRating || 'N/A'}</span></p>
      </div>
      <div class="flex gap-3">
        <a href="/movie/${imdbID}" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-center">
          Ver Detalle Completo
        </a>
      </div>
    `;

		const modal = document.getElementById("modal");
		if (!modal) {
			console.error("Modal no encontrado");
			return;
		}
		modal.setAttribute("data-current-imdbid", imdbID);
		modal.classList.remove("hidden");
		document.body.classList.add("overflow-hidden");
		setTimeout(() => {
			modal.classList.remove("opacity-0", "scale-95");
			modal.classList.add("opacity-100", "scale-100");
		}, 10);

		// Update favorite button in modal
		const favoriteBtn = document.getElementById("favorite-modal-btn");
		if (favoriteBtn) {
			const icon = favoriteBtn.querySelector(".material-icons");
			if (icon) {
				if (isFavorite(imdbID)) {
					icon.textContent = "favorite";
					icon.classList.add("text-red-600");
				} else {
					icon.textContent = "favorite_border";
					icon.classList.remove("text-red-600");
				}
			}
		}
		} catch (error) {
			console.error('Error opening modal:', error);
			// Show error message in modal
			const modalContent = document.getElementById("modal-content");
			if (modalContent) {
				modalContent.innerHTML = `
					<div class="text-center py-8">
						<div class="material-icons text-6xl text-red-400 mb-4">error</div>
						<h3 class="text-xl font-semibold text-gray-800 mb-2">Error al cargar la película</h3>
						<p class="text-gray-600">No se pudo obtener la información de la película.</p>
					</div>
				`;
			}
		}
	}

	function closeModal() {
		const modal = document.getElementById("modal");
		if (!modal) {
			console.error("Modal no encontrado");
			return;
		}
		modal.classList.remove("opacity-100", "scale-100");
		modal.classList.add("opacity-0", "scale-95");
		document.body.classList.remove("overflow-hidden");
		setTimeout(() => {
			modal.classList.add("hidden");
		}, 300);
	}

	document.addEventListener("DOMContentLoaded", () => {
		const cards = document.querySelectorAll(".card");
		cards.forEach((card) => {
			card.addEventListener("click", () => {
				const imdbID = card.getAttribute("data-imdbid");
				if (imdbID) {
					openModal(imdbID);
				} else {
					console.error("IMDBID No encontrado");
				}
			});
		});

		const closeModalBtn = document.getElementById("close-modal");
		if (closeModalBtn) {
			closeModalBtn.addEventListener("click", closeModal);
		} else {
			console.error("Close modal button not found");
		}

		const modal = document.getElementById("modal");
		if (modal) {
			modal.addEventListener("click", (e: MouseEvent) => {
				if (e.target === modal) {
					closeModal();
				}
			});

			// Handle favorite button in modal
			const favoriteBtn = document.getElementById("favorite-modal-btn");
			if (favoriteBtn) {
				favoriteBtn.addEventListener("click", () => {
					const imdbID = modal.getAttribute("data-current-imdbid");
					if (imdbID) {
						const icon = favoriteBtn.querySelector(".material-icons");
						if (icon) {
							if (isFavorite(imdbID)) {
								removeFavorite(imdbID);
								icon.textContent = "favorite_border";
								icon.classList.remove("text-red-600");
							} else {
								addFavorite(imdbID);
								icon.textContent = "favorite";
								icon.classList.add("text-red-600");
							}
						}
					}
				});
			}
		} else {
			console.error("Modal element not found");
		}
	});
</script>

---
export interface Props {
  movie: {
    Title: string;
    Year: string;
    Poster: string;
    imdbID: string;
    Type?: string;
  };
  class?: string;
}

const { movie, class: className } = Astro.props;
const isSwiper = className && className.includes('absolute');
const placeholderSmall = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';
---

<div class={`bg-[rgb(var(--card-bg))] overflow-hidden ${isSwiper ? 'rounded-3xl transform transition-all duration-300' : 'shrink-0 w-40 md:w-auto bg-opacity-90 backdrop-blur-xl rounded-xl hover:scale-105 transition-all duration-500 ease-out animate-fade-in-up cursor-pointer card h-64 relative'} ${className || ''}`} data-imdbid={movie.imdbID} data-title={movie.Title} data-poster={movie.Poster} data-year={movie.Year} data-type={movie.Type}>
  {!isSwiper && <button class="absolute top-2 right-2 bg-[rgb(var(--card-bg))] bg-opacity-80 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-100 transition-all favorite-btn" data-imdbid={movie.imdbID}>
    <span class="material-icons text-red-500 text-base leading-none">favorite_border</span>
  </button>}
  {isSwiper ? (
    <div class="relative h-3/4 overflow-hidden">
      <img src={movie.Poster !== 'N/A' ? movie.Poster : placeholderSmall} alt={movie.Title} class="w-full h-full object-cover" loading="lazy">
      <div class="absolute inset-0 bg-linear-to-t from-black/80 via-transparent to-transparent"></div>
      {movie.Type && (
        <div class="absolute top-4 left-4 bg-black/50 text-white px-3 py-1 rounded-full text-sm font-medium">
          {movie.Type === 'movie' ? 'Pel√≠cula' : 'Serie'}
        </div>
      )}
      <div class="absolute top-1/2 left-4 transform -translate-y-1/2 opacity-0 transition-opacity duration-300" id="nope-indicator">
        <div class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold text-xl rotate-12 shadow-lg">
          NOPE
        </div>
      </div>
      <div class="absolute top-1/2 right-4 transform -translate-y-1/2 opacity-0 transition-opacity duration-300" id="like-indicator">
        <div class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-xl -rotate-12 shadow-lg">
          LIKE
        </div>
      </div>
    </div>
  ) : (
    <img src={movie.Poster !== 'N/A' ? movie.Poster : placeholderSmall} alt={movie.Title} class="w-full h-48 object-cover rounded-t-xl" loading="lazy">
  )}
  <div class={` ${isSwiper ? 'p-6 h-1/4 flex flex-col justify-between' : 'p-4'}`}>
    <div>
      <h3 class={` ${isSwiper ? 'text-xl' : 'text-sm'} ${isSwiper ? '' : 'truncate'} text-[rgb(var(--text))] mb-1 line-clamp-2`}>{movie.Title}</h3>
      <p class={` ${isSwiper ? '' : 'text-xs'} text-[rgb(var(--text-secondary))]`}>{movie.Year}</p>
    </div>
  </div>
</div>

<script>
  import { addFavorite, removeFavorite, isFavorite } from '../lib/favorites.js';

  document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
      if (!card.classList.contains('swiper-card')) {
        card.addEventListener('click', () => {
          const imdbID = card.getAttribute('data-imdbid');
          if (imdbID) {
            window.location.href = `/movie/${imdbID}`;
          }
        });
      }
    });

    const favoriteBtns = document.querySelectorAll('.favorite-btn');
    favoriteBtns.forEach(btn => {
      const imdbID = btn.getAttribute('data-imdbid');
      if (imdbID) {
        const icon = btn.querySelector('.material-icons');
        if (icon) {
          if (isFavorite(imdbID)) {
            icon.textContent = 'favorite';
            icon.classList.add('text-red-600');
          }
        }

        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (imdbID) {
            if (isFavorite(imdbID)) {
              removeFavorite(imdbID);
              if (icon) {
                icon.textContent = 'favorite_border';
                icon.classList.remove('text-red-600');
              }
            } else {
              addFavorite(imdbID);
              if (icon) {
                icon.textContent = 'favorite';
                icon.classList.add('text-red-600');
              }
            }
          }
        });
      }
    });
  });
</script>